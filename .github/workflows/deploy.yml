name: DocuFlux VPS Deployment

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Repository auschecken
      uses: actions/checkout@v4
      
    - name: Deployment auf VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 60s
        script: |
          set -e
          
          echo "ğŸš€ DocuFlux Deployment gestartet..."
          echo "ğŸ“… Deployment begonnen um: $(date)"
          echo "ğŸ‘¤ Benutzer: $(whoami)"
          
          # Zum Deployment-Verzeichnis navigieren
          if [ ! -d "/opt/docuflux" ]; then
            echo "ğŸ“ Erstelle Deployment-Verzeichnis..."
            sudo mkdir -p /opt/docuflux
            sudo chown $(whoami):$(whoami) /opt/docuflux
          fi
          
          cd /opt/docuflux || { echo "âŒ Fehler: Kann nicht zu /opt/docuflux navigieren"; exit 1; }
          echo "ğŸ“‚ Arbeite in: $(pwd)"
          
          # Backup der aktuellen Deployment erstellen
          if [ -d "landing-pages-backup" ]; then
            echo "ğŸ—‘ï¸ Entferne altes Backup..."
            rm -rf landing-pages-backup
          fi
          
          if [ -d "landing-pages" ]; then
            echo "ğŸ’¾ Erstelle Backup der aktuellen Deployment..."
            cp -r landing-pages landing-pages-backup
          fi
          
          # Neuesten Code von GitHub herunterladen (HTTPS - kein SSH erforderlich)
          echo "ğŸ“¥ Lade neuesten Code von GitHub herunter..."
          
          # Entferne existierendes Repository-Verzeichnis
          if [ -d "repo" ]; then
            rm -rf repo
          fi
          
          # Repository mit HTTPS klonen (getestet und funktioniert)
          if git clone https://github.com/adneraadmin/docuflux.git repo; then
            echo "âœ… Repository erfolgreich geklont"
          else
            echo "âš ï¸ Git-Klon fehlgeschlagen, versuche wget-Methode..."
            wget -O repo.zip https://github.com/adneraadmin/docuflux/archive/refs/heads/master.zip
            unzip -o repo.zip
            mv docuflux-master repo
            rm repo.zip
            echo "âœ… Repository Ã¼ber wget heruntergeladen"
          fi
          
          # Landing Pages von apps/landing-pages aktualisieren
          if [ -d "repo/apps/landing-pages" ]; then
            echo "ğŸ“‹ Aktualisiere Landing Pages vom Repository..."
            mkdir -p landing-pages
            
            # Kopiere alle Inhalte von apps/landing-pages
            cp -r repo/apps/landing-pages/* landing-pages/ 2>/dev/null || echo "Keine Dateien in repo/apps/landing-pages"
            
            echo "ğŸ“‚ Landing Pages aktualisiert:"
            ls -la landing-pages/
          else
            echo "âš ï¸ Kein apps/landing-pages Verzeichnis im Repository gefunden"
          fi
          
          # ZusÃ¤tzliche Dateien kopieren falls vorhanden
          if [ -f "repo/Dockerfile.kmu" ]; then
            echo "ğŸ³ Aktualisiere Dockerfiles..."
            cp repo/Dockerfile.* . 2>/dev/null || echo "Keine Dockerfiles zu aktualisieren"
          fi
          
          if [ -f "repo/docker-compose.yml" ]; then
            echo "ğŸ³ Aktualisiere docker-compose.yml..."
            sudo cp repo/docker-compose.yml /root/ || echo "Fehler beim Aktualisieren der docker-compose.yml"
          fi
          
          if [ -f "repo/nginx.conf" ]; then
            echo "âš™ï¸ Aktualisiere nginx Konfiguration..."
            cp repo/nginx.conf .
          fi
          
          # Docker-VerfÃ¼gbarkeit prÃ¼fen
          echo "ğŸ³ PrÃ¼fe Docker-Status..."
          if ! command -v docker >/dev/null 2>&1; then
            echo "âŒ Docker ist nicht verfÃ¼gbar"
            exit 1
          fi
          
          if ! command -v docker-compose >/dev/null 2>&1; then
            echo "âŒ docker-compose ist nicht verfÃ¼gbar"
            exit 1
          fi
          
          echo "âœ… Docker und docker-compose sind verfÃ¼gbar"
          
          # Zum docker-compose Verzeichnis navigieren
          if [ -f "/root/docker-compose.yml" ]; then
            echo "ğŸ³ Verwende docker-compose aus /root"
            cd /root
          elif [ -f "/opt/docuflux/docker-compose.yml" ]; then
            echo "ğŸ³ Verwende docker-compose aus /opt/docuflux"
            cd /opt/docuflux
          else
            echo "âŒ docker-compose.yml nicht gefunden"
            echo "ğŸ“‚ Inhalt von /root:"
            sudo ls -la /root/ || echo "Kann nicht auf /root zugreifen"
            echo "ğŸ“‚ Inhalt von /opt/docuflux:"
            ls -la /opt/docuflux/
            exit 1
          fi
          
          # Docker Container neu erstellen
          echo "ğŸ³ Erstelle Docker Container neu..."
          services="docuflux-kmu docuflux-handwerk docuflux-buchhaltung docuflux-beta"
          
          for service in $services; do
            echo "Erstelle $service..."
            if docker-compose build --no-cache $service 2>/dev/null; then
              echo "âœ… $service erfolgreich erstellt"
            elif sudo docker-compose build --no-cache $service 2>/dev/null; then
              echo "âœ… $service erfolgreich mit sudo erstellt"
            else
              echo "âš ï¸ Fehler beim Erstellen von $service, fahre fort..."
            fi
          done
          
          # Services neu starten
          echo "ğŸ”„ Starte Services neu..."
          if docker-compose up -d $services 2>/dev/null; then
            echo "âœ… Services erfolgreich gestartet"
          elif sudo docker-compose up -d $services; then
            echo "âœ… Services erfolgreich mit sudo gestartet"
          else
            echo "âš ï¸ Einige Services konnten nicht gestartet werden"
          fi
          
          # Warten bis Services gestartet sind
          echo "â³ Warte bis Services gestartet sind..."
          sleep 30
          
          # Service-Status prÃ¼fen
          echo "ğŸ§ª PrÃ¼fe Service-Status..."
          for service in $services; do
            if docker-compose ps -q $service >/dev/null 2>&1; then
              status=$(docker-compose ps $service 2>/dev/null | tail -n +3 | awk '{print $4}' || echo "unbekannt")
              echo "ğŸ“Š $service: $status"
            elif sudo docker-compose ps -q $service >/dev/null 2>&1; then
              status=$(sudo docker-compose ps $service 2>/dev/null | tail -n +3 | awk '{print $4}' || echo "unbekannt")
              echo "ğŸ“Š $service: $status (mit sudo geprÃ¼ft)"
            else
              echo "âŒ $service: Nicht gefunden"
            fi
          done
          
          # Endpunkte testen
          echo "ğŸ” Teste Endpunkte..."
          for subdomain in kmu handwerk buchhaltung beta; do
            echo "Teste $subdomain.docuflux.de..."
            status=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 https://$subdomain.docuflux.de 2>/dev/null || echo "000")
            if [ "$status" = "200" ] || [ "$status" = "301" ] || [ "$status" = "302" ]; then
              echo "âœ… $subdomain.docuflux.de antwortet (HTTP $status)"
            else
              echo "âš ï¸ $subdomain.docuflux.de gab HTTP $status zurÃ¼ck"
            fi
          done
          
          echo "ğŸ‰ Deployment abgeschlossen!"
          echo "ğŸ“… Deployment beendet um: $(date)"
          
    - name: Deployment-Status benachrichtigen
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Deployment erfolgreich!"
          echo ""
          echo "ğŸŒ Landing Pages aktualisiert und verfÃ¼gbar unter:"
          echo "   - https://kmu.docuflux.de"
          echo "   - https://handwerk.docuflux.de"
          echo "   - https://buchhaltung.docuflux.de"
          echo "   - https://beta.docuflux.de"
          echo ""
          echo "ğŸ“‹ Repository-Struktur bestÃ¤tigt:"
          echo "   - Landing Pages in apps/landing-pages/ gefunden"
          echo "   - Dateien erfolgreich auf VPS kopiert"
          echo "   - Docker Services neu erstellt und gestartet"
        else
          echo "âŒ Deployment fehlgeschlagen!"
          echo "Bitte prÃ¼fen Sie die Logs oben fÃ¼r Details."
          echo ""
          echo "ğŸ”§ Fehlerbehebung:"
          echo "   1. VPS_HOST, VPS_USER und VPS_SSH_KEY Secrets Ã¼berprÃ¼fen"
          echo "   2. Docker-Installation und Berechtigungen auf VPS prÃ¼fen"
          echo "   3. Sicherstellen dass /opt/docuflux existiert und beschreibbar ist"
          echo "   4. ÃœberprÃ¼fen dass docker-compose.yml in /root oder /opt/docuflux existiert"
        fi
